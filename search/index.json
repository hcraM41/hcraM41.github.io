[{"content":"ä¸€ã€deferçš„ç®€å•ä½¿ç”¨ defer æ‹¥æœ‰æ³¨å†Œå»¶è¿Ÿè°ƒç”¨çš„æœºåˆ¶ï¼Œdefer å…³é”®å­—åé¢è·Ÿéšçš„è¯­å¥æˆ–è€…å‡½æ•°ï¼Œä¼šåœ¨å½“å‰çš„å‡½æ•°return æ­£å¸¸ç»“æŸ æˆ–è€… panic å¼‚å¸¸ç»“æŸ åæ‰§è¡Œã€‚\nä½†æ˜¯defer åªæœ‰åœ¨æ³¨å†Œåï¼Œæœ€åæ‰èƒ½ç”Ÿæ•ˆè°ƒç”¨æ‰§è¡Œï¼Œreturn ä¹‹åçš„defer è¯­å¥æ˜¯ä¸ä¼šæ‰§è¡Œçš„ï¼Œå› ä¸ºå¹¶æ²¡æœ‰æ³¨å†ŒæˆåŠŸã€‚\nå¦‚ä¸‹ä¾‹å­ï¼š\nfunc main() { defer func() { fmt.Println(111) }() fmt.Println(222) return defer func() { fmt.Println(333) }() } æ‰§è¡Œç»“æœï¼š\n222 111 è§£æï¼š222 ã€111 æ˜¯åœ¨return ä¹‹å‰æ³¨å†Œçš„ï¼Œæ‰€ä»¥å¦‚æœŸæ‰§è¡Œï¼Œ333 æ˜¯åœ¨return ä¹‹åæ³¨å†Œçš„ï¼Œæ³¨å†Œå¤±è´¥ï¼Œæ‰§è¡Œä¸äº†ã€‚\ndefer åœ¨éœ€è¦èµ„æºé‡Šæ”¾çš„åœºæ™¯éå¸¸æœ‰ç”¨ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°åœ¨å‡½æ•°ç»“æŸå‰æ‰§è¡Œä¸€äº›æ“ä½œã€‚\næ¯”å¦‚åœ¨ æ‰“å¼€è¿æ¥/å…³é—­è¿æ¥ ã€åŠ é”/é‡Šæ”¾é”ã€æ‰“å¼€æ–‡ä»¶/å…³é—­æ–‡ä»¶ è¿™äº›åœºæ™¯ä¸‹ï¼š\nfile, err := os.Open(\u0026#34;1.txt\u0026#34;) if err != nil { panic(err) } if file != nil { defer file.Close() } è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼šåœ¨è°ƒç”¨file.Close() ä¹‹å‰ï¼Œéœ€è¦åˆ¤æ–­file æ˜¯å¦ä¸ºç©ºï¼Œé¿å…å‡ºç°å¼‚å¸¸æƒ…å†µã€‚\nå†æ¥çœ‹ä¸€ä¸ªé”™è¯¯ç¤ºèŒƒï¼Œæ²¡æœ‰æ­£ç¡®ä½¿ç”¨defer çš„ä¾‹å­ï¼š\nplayer.mu.Lock() rand.Intn(number) player.mu.Unlock() è¿™ä¸‰è¡Œä»£ç ï¼Œå­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š 1. ä¸­é—´è¿™è¡Œä»£ç  rand.Intn(number) æ˜¯æœ‰å¯èƒ½å‘ç”Ÿpanic çš„ï¼Œè¿™å°±ä¼šå¯¼è‡´æ²¡æœ‰æ­£å¸¸è§£é”ã€‚ 2. è¿™æ ·çš„ä»£ç åœ¨é¡¹ç›®ä¸­åç»­å¯èƒ½è¢«å…¶ä»–äººä¿®æ”¹ï¼Œåœ¨rand.Intn(number) åå¢åŠ æ›´å¤šçš„é€»è¾‘ï¼Œè¿™æ˜¯å®Œå…¨ä¸å¯æ§çš„ã€‚\nåœ¨Lock å’Œ Unlock ä¹‹é—´çš„ä»£ç ä¸€æ—¦å‡ºç° panic ï¼Œå°±ä¼šé€ æˆæ­»é”ã€‚å› æ­¤ï¼Œå³ä½¿é€»è¾‘éå¸¸ç®€å•ï¼Œä½¿ç”¨defer ä¹Ÿæ˜¯å¾ˆæœ‰å¿…è¦çš„ï¼Œå› ä¸ºéœ€æ±‚æ€»åœ¨å˜åŒ–ï¼Œä»£ç ä¹Ÿæ€»ä¼šè¢«ä¿®æ”¹ã€‚\näºŒã€deferçš„å‡½æ•°å‚æ•°ä¸é—­åŒ…å¼•ç”¨ defer å»¶è¿Ÿè¯­å¥ä¸ä¼šé©¬ä¸Šæ‰§è¡Œï¼Œè€Œæ˜¯ä¼šè¿›å…¥ä¸€ä¸ªæ ˆï¼Œå‡½æ•°return å‰ï¼Œä¼šæŒ‰å…ˆè¿›åå‡ºçš„é¡ºåºæ‰§è¡Œã€‚\nå…ˆè¿›åå‡ºçš„åŸå› æ˜¯åé¢å®šä¹‰çš„å‡½æ•°å¯èƒ½ä¼šä¾èµ–å‰é¢çš„èµ„æºï¼Œè‡ªç„¶è¦å…ˆæ‰§è¡Œï¼›å¦åˆ™ï¼Œå¦‚æœå‰é¢çš„å…ˆæ‰§è¡Œäº†ï¼Œé‚£ä¹ˆåé¢å‡½æ•°çš„ä¾èµ–å°±æ²¡æœ‰äº†ï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´å‡ºé”™ã€‚\nåœ¨defer å‡½æ•°å®šä¹‰æ—¶ï¼Œå¯¹å¤–éƒ¨å˜é‡çš„å¼•ç”¨æœ‰ä¸‰ç§æ–¹å¼ï¼šå€¼ä¼ å‚ã€æŒ‡é’ˆä¼ å‚ã€é—­åŒ…å¼•ç”¨ã€‚\nå€¼ä¼ å‚ï¼šåœ¨defer å®šä¹‰æ—¶å°±æŠŠå€¼ä¼ é€’ç»™defer ï¼Œå¹¶å¤åˆ¶ä¸€ä»½cacheèµ·æ¥ï¼Œdeferè°ƒç”¨æ—¶å’Œå®šä¹‰çš„æ—¶å€™å€¼æ˜¯ä¸€è‡´çš„ã€‚ æŒ‡é’ˆä¼ å‚ï¼šåœ¨defer å®šä¹‰æ—¶å°±æŠŠæŒ‡é’ˆä¼ é€’ç»™defer ï¼Œdeferè°ƒç”¨æ—¶æ ¹æ®æ•´ä¸ªä¸Šä¸‹æ–‡ç¡®å®šå‚æ•°å½“å‰çš„å€¼ã€‚ é—­åŒ…å¼•ç”¨ï¼šåœ¨defer å®šä¹‰æ—¶å°±æŠŠå€¼å¼•ç”¨ä¼ é€’ç»™defer ï¼Œdeferè°ƒç”¨æ—¶æ ¹æ®æ•´ä¸ªä¸Šä¸‹æ–‡ç¡®å®šå‚æ•°å½“å‰çš„å€¼ã€‚ ä¸‹é¢é€šè¿‡ä¾‹å­åŠ æ·±ä¸€ä¸‹ç†è§£ã€‚\nä¾‹å­1ï¼š\nfunc main() { var arr [4]struct{} for i := range arr { defer func() { fmt.Println(i) }() } } æ‰§è¡Œç»“æœï¼š\n3 3 3 3 è§£æï¼šå› ä¸ºdefer åé¢è·Ÿç€çš„æ˜¯ä¸€ä¸ªé—­åŒ…ï¼Œæ ¹æ®æ•´ä¸ªä¸Šä¸‹æ–‡ç¡®å®šï¼Œfor å¾ªç¯ç»“æŸåi çš„å€¼ä¸º3ï¼Œå› æ­¤æœ€åæ‰“å°äº†4ä¸ª3ã€‚\nä¾‹å­2ï¼š\nfunc main() { var n int // å€¼ä¼ å‚ defer func(n1 int) { fmt.Println(n1) }(n) // æŒ‡é’ˆä¼ å‚ defer func(n2 *int) { fmt.Println(*n2) }(\u0026amp;n) // é—­åŒ… defer func() { fmt.Println(n) }() n = 4 } æ‰§è¡Œç»“æœï¼š\n4 4 0 è§£æï¼š\ndefer æ‰§è¡Œé¡ºåºå’Œå®šä¹‰çš„é¡ºåºæ˜¯ç›¸åçš„ï¼›\nç¬¬ä¸‰ä¸ªdefer è¯­å¥æ˜¯é—­åŒ…ï¼Œå¼•ç”¨çš„å¤–éƒ¨å˜é‡n ï¼Œdeferè°ƒç”¨æ—¶æ ¹æ®ä¸Šä¸‹æ–‡ç¡®å®šï¼Œæœ€ç»ˆç»“æœæ˜¯4ï¼›\nç¬¬äºŒä¸ªdefer è¯­å¥æ˜¯æŒ‡é’ˆä¼ å‚ï¼Œdeferè°ƒç”¨æ—¶æ ¹æ®æ•´ä¸ªä¸Šä¸‹æ–‡ç¡®å®šå‚æ•°å½“å‰çš„å€¼ï¼Œæœ€ç»ˆç»“æœæ˜¯4ï¼›\nç¬¬ä¸€ä¸ªdefer è¯­å¥æ˜¯å€¼ä¼ å‚ï¼Œdeferè°ƒç”¨æ—¶å’Œå®šä¹‰çš„æ—¶å€™å€¼æ˜¯ä¸€è‡´çš„ï¼Œæœ€ç»ˆç»“æœæ˜¯0ï¼›\nä¾‹å­3ï¼š\nfunc main() { // æ–‡ä»¶1 f, _ := os.Open(\u0026#34;1.txt\u0026#34;) if f != nil { defer func(f io.Closer) { if err := f.Close(); err != nil { fmt.Printf(\u0026#34;defer close file err 1 %v\\n\u0026#34;, err) } }(f) } // æ–‡ä»¶2 f, _ = os.Open(\u0026#34;2.txt\u0026#34;) if f != nil { defer func(f io.Closer) { if err := f.Close(); err != nil { fmt.Printf(\u0026#34;defer close file err 2 %v\\n\u0026#34;, err) } }(f) } fmt.Println(\u0026#34;success\u0026#34;) } æ‰§è¡Œç»“æœï¼š\nsuccess è§£æï¼šå…ˆè¯´ç»“è®ºï¼Œè¿™ä¸ªä¾‹å­çš„ä»£ç æ²¡æœ‰é—®é¢˜ï¼Œä¸¤ä¸ªæ–‡ä»¶éƒ½ä¼šè¢«æˆåŠŸå…³é—­ã€‚è¿™ä¸ªæ˜¯å¯¹defer åŸç†çš„åº”ç”¨ï¼Œå› ä¸ºdefer å‡½æ•°åœ¨å®šä¹‰çš„æ—¶å€™ï¼Œå‚æ•°å°±å·²ç»å¤åˆ¶è¿›å»äº†ï¼Œè¿™é‡Œæ˜¯å€¼ä¼ å‚ï¼ŒçœŸæ­£æ‰§è¡Œclose() å‡½æ•°çš„æ—¶å€™å°±åˆšå¥½å…³é—­çš„æ˜¯æ­£ç¡®çš„æ–‡ä»¶ã€‚å¦‚æœä¸æŠŠf å½“åšå€¼ä¼ å‚ï¼Œæœ€åä¸¤ä¸ªclose() å‡½æ•°å…³é—­çš„å°±æ˜¯åŒä¸€ä¸ªæ–‡ä»¶äº†ï¼Œéƒ½æ˜¯æœ€åæ‰“å¼€çš„é‚£ä¸ªæ–‡ä»¶ã€‚\nä¾‹å­3çš„é”™è¯¯ç¤ºèŒƒï¼š\nfunc main() { // æ–‡ä»¶1 f, _ := os.Open(\u0026#34;1.txt\u0026#34;) if f != nil { defer func() { if err := f.Close(); err != nil { fmt.Printf(\u0026#34;defer close file err 1 %v\\n\u0026#34;, err) } }() } // æ–‡ä»¶2 f, _ = os.Open(\u0026#34;2.txt\u0026#34;) if f != nil { defer func() { if err := f.Close(); err != nil { fmt.Printf(\u0026#34;defer close file err 2 %v\\n\u0026#34;, err) } }() } fmt.Println(\u0026#34;success\u0026#34;) } æ‰§è¡Œç»“æœï¼š\nsuccess defer close file err 1 close 2.txt: file already closed ä¾‹å­4ï¼š\n// å€¼ä¼ å‚ func func1() { var err error defer fmt.Println(err) err = errors.New(\u0026#34;func1 error\u0026#34;) return } // é—­åŒ… func func2() { var err error defer func() { fmt.Println(err) }() err = errors.New(\u0026#34;func2 error\u0026#34;) return } // å€¼ä¼ å‚ func func3() { var err error defer func(err error) { fmt.Println(err) }(err) err = errors.New(\u0026#34;func3 error\u0026#34;) return } // æŒ‡é’ˆä¼ å‚ func func4() { var err error defer func(err *error) { fmt.Println(*err) }(\u0026amp;err) err = errors.New(\u0026#34;func4 error\u0026#34;) return } func main() { func1() func2() func3() func4() } æ‰§è¡Œç»“æœï¼š\n\u0026lt;nil\u0026gt; func2 error \u0026lt;nil\u0026gt; func4 error è§£æï¼š\nç¬¬ä¸€ä¸ªå’Œç¬¬ä¸‰ä¸ªå‡½æ•°ä¸­ï¼Œéƒ½æ˜¯ä½œä¸ºå‚æ•°ï¼Œè¿›è¡Œå€¼ä¼ å‚ï¼Œerr åœ¨å®šä¹‰çš„æ—¶å€™å°±ä¼šæ±‚å€¼ï¼Œå› ä¸ºå®šä¹‰çš„æ—¶å€™å€¼éƒ½æ˜¯nil ï¼Œæ‰€ä»¥æœ€åçš„ç»“æœéƒ½æ˜¯nil ï¼›\nç¬¬äºŒä¸ªå‡½æ•°çš„å‚æ•°åœ¨å®šä¹‰çš„æ—¶å€™ä¹Ÿæ±‚å€¼äº†ï¼Œä½†æ˜¯å®ƒæ˜¯ä¸ªé—­åŒ…ï¼ŒæŸ¥çœ‹ä¸Šä¸‹æ–‡å‘ç°æœ€åå€¼è¢«ä¿®æ”¹ä¸ºfunc2 error ï¼›\nç¬¬å››ä¸ªå‡½æ•°æ˜¯æŒ‡é’ˆä¼ å‚ï¼Œæœ€åå€¼è¢«ä¿®æ”¹ä¸ºfunc4 error ï¼›\nç°å®ä¸­ï¼Œç¬¬ä¸‰ä¸ªå‡½æ•°é—­åŒ…çš„ä¾‹å­æ˜¯æ¯”è¾ƒå®¹æ˜“çŠ¯çš„é”™è¯¯ï¼Œå¯¼è‡´æœ€ådefer è¯­å¥æ²¡æœ‰èµ·åˆ°ä½œç”¨ï¼Œé€ æˆç”Ÿäº§ä¸Šçš„äº‹æ•…ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚\nä¸‰ã€deferçš„è¯­å¥æ‹†è§£ ä»è¿”å›å€¼å‡ºå‘æ¥æ‹†è§£å»¶è¿Ÿè¯­å¥ defer ã€‚\nâ€‹\treturn xxx\nè¿™æ¡è¯­å¥ç»è¿‡ç¼–è¯‘ä¹‹åï¼Œå®é™…ä¸Šç”Ÿæˆäº†ä¸‰æ¡æŒ‡ä»¤ï¼š\nè¿”å›å€¼ = xxx è°ƒç”¨ defer å‡½æ•° ç©ºçš„ return å…¶ä¸­ï¼Œ1 å’Œ 3 æ˜¯return è¯­å¥ç”Ÿæˆçš„æŒ‡ä»¤ï¼Œ2 æ˜¯defer è¯­å¥ç”Ÿæˆçš„æŒ‡ä»¤ã€‚å¯ä»¥çœ‹å‡ºï¼š\nreturn å¹¶ä¸æ˜¯ä¸€æ¡åŸå­æŒ‡ä»¤ï¼›defer è¯­å¥åœ¨ç¬¬äºŒæ­¥è°ƒç”¨ï¼Œè¿™é‡Œå¯èƒ½æ“ä½œè¿”å›å€¼ï¼Œä»è€Œå½±å“æœ€ç»ˆç»“æœã€‚\næ¥ä¸‹æ¥é€šè¿‡ä¾‹å­æ¥åŠ æ·±ç†è§£ã€‚\nä¾‹å­1ï¼š\nfunc func1() (r int) { t := 3 defer func() { t = t + 3 }() return t } func main() { r := func1() fmt.Println(r) } æ‰§è¡Œç»“æœï¼š\n3 è¯­å¥æ‹†è§£ï¼š\nfunc func1() (r int) { t := 3 // 1.è¿”å›å€¼=xxxï¼šèµ‹å€¼æŒ‡ä»¤ r = t // 2.è°ƒç”¨deferå‡½æ•°ï¼šdeferåœ¨èµ‹å€¼ä¸è¿”å›ä¹‹å‰æ‰§è¡Œï¼Œè¿™ä¸ªä¾‹å­ä¸­è¿”å›å€¼ræ²¡æœ‰è¢«ä¿®æ”¹è¿‡ func() { t = t + 3 }() // 3.ç©ºçš„return return } func main() { r := func1() fmt.Println(r) } è§£æï¼šå› ä¸ºç¬¬äºŒä¸ªæ­¥éª¤é‡Œå¹¶æ²¡æœ‰æ“ä½œè¿”å›å€¼r ï¼Œæ‰€ä»¥æœ€ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯3 ã€‚\nä¾‹å­2ï¼š\nfunc func2() (r int) { defer func(r int) { r = r + 3 }(r) return 1 } func main() { r := func2() fmt.Println(r) } æ‰§è¡Œç»“æœï¼š\n1 è¯­å¥æ‹†è§£ï¼š\nfunc func2() (r int) { // 1.è¿”å›å€¼=xxxï¼šèµ‹å€¼æŒ‡ä»¤ r = 1 // 2.è°ƒç”¨deferå‡½æ•°ï¼šå› ä¸ºæ˜¯å€¼ä¼ å‚ï¼Œæ‰€ä»¥ä¿®æ”¹çš„ræ˜¯ä¸ªå¤åˆ¶çš„å€¼ï¼Œä¸ä¼šå½±å“è¦è¿”å›çš„é‚£ä¸ªrå€¼ã€‚ func(r int) { r = r + 3 }(r) // 3.ç©ºçš„return return } func main() { r := func2() fmt.Println(r) } è§£æï¼šå› ä¸ºç¬¬äºŒä¸ªæ­¥éª¤é‡Œæ”¹å˜çš„æ˜¯ä¼ å€¼è¿›å»çš„r å€¼ï¼Œæ˜¯ä¸€ä¸ªå½¢å‚çš„å¤åˆ¶å€¼ï¼Œä¸ä¼šå½±å“å®å‚r ï¼Œæ‰€ä»¥æœ€ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯1 ã€‚\nä¾‹å­3ï¼š\nfunc func3() (r int) { defer func() { r = r + 3 }() return 1 } func main() { r := func3() fmt.Println(r) } æ‰§è¡Œç»“æœï¼š\n4 è¯­å¥æ‹†è§£ï¼š\nfunc func3() (r int) { // 1.è¿”å›å€¼=xxxï¼šèµ‹å€¼æŒ‡ä»¤ r = 1 // 2.è°ƒç”¨deferå‡½æ•°ï¼šå› ä¸ºæ˜¯é—­åŒ…ï¼Œæ•è·çš„å˜é‡æ˜¯å¼•ç”¨ä¼ é€’ï¼Œæ‰€ä»¥ä¼šä¿®æ”¹è¿”å›çš„é‚£ä¸ªrå€¼ã€‚ func() { r = r + 3 }() // 3.ç©ºçš„return return } func main() { r := func3() fmt.Println(r) } è§£æï¼šå› ä¸ºç¬¬äºŒä¸ªæ­¥éª¤é‡Œæ”¹å˜çš„r å€¼æ˜¯é—­åŒ…ï¼Œé—­åŒ…ä¸­æ•è·çš„å˜é‡æ˜¯å¼•ç”¨ä¼ é€’ï¼Œä¸æ˜¯å€¼ä¼ é€’ï¼Œæ‰€ä»¥æœ€ç»ˆå¾—åˆ°çš„ç»“æœæ˜¯4 ã€‚\nå››ã€deferä¸­çš„recover ä»£ç ä¸­çš„panic æœ€ç»ˆä¼šè¢«recover æ•è·åˆ°ã€‚åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œå¯èƒ½æŸä¸€æ¡åè®®çš„é€»è¾‘è§¦å‘äº†æŸä¸€ä¸ªbug é€ æˆpanic ï¼Œè¿™æ—¶å°±å¯ä»¥ç”¨recover å»æ•è·panic ï¼Œç¨³ä½ä¸»æµç¨‹ï¼Œä¸å½±å“å…¶ä»–åè®®çš„ä¸šåŠ¡é€»è¾‘ã€‚\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œrecover å‡½æ•°åªåœ¨defer çš„å‡½æ•°ä¸­ç›´æ¥è°ƒç”¨æ‰ç”Ÿæ•ˆã€‚\né€šè¿‡ä¾‹å­çœ‹recover è°ƒç”¨æƒ…å†µã€‚\nä¾‹å­1ï¼š\nfunc func1() { if err := recover(); err != nil { fmt.Println(\u0026#34;func1 recover\u0026#34;, err) return } } func main() { defer func1() panic(\u0026#34;func1 panic\u0026#34;) } æ‰§è¡Œç»“æœï¼š\nfunc1 recover func1 panic è§£æï¼šæ­£ç¡®recover ï¼Œå› ä¸ºåœ¨defer ä¸­è°ƒç”¨çš„ï¼Œæ‰€ä»¥å¯ä»¥ç”Ÿæ•ˆã€‚\nä¾‹å­2ï¼š\nfunc main() { recover() panic(\u0026#34;func2 panic\u0026#34;) } æ‰§è¡Œç»“æœï¼š\npanic: func2 panic goroutine 1 [running]: main.main() C:/Users/ycz/go/ccc.go:5 +0x31 exit status 2 è§£æï¼šé”™è¯¯recover ï¼Œç›´æ¥è°ƒç”¨recover ï¼Œè¿”å›nil ã€‚\nä¾‹å­3ï¼š\nfunc main() { defer recover() panic(\u0026#34;func3 panic\u0026#34;) } æ‰§è¡Œç»“æœï¼š\npanic: func3 panic goroutine 1 [running]: main.main() C:/Users/ycz/go/ccc.go:5 +0x65 exit status 2 è§£æï¼šé”™è¯¯recover ï¼Œrecover éœ€è¦åœ¨defer çš„å‡½æ•°é‡Œè°ƒç”¨ã€‚\nä¾‹å­4ï¼š\nfunc main() { defer func() { defer func() { recover() }() }() panic(\u0026#34;func4 panic\u0026#34;) } æ‰§è¡Œç»“æœï¼š\npanic: func4 panic goroutine 1 [running]: main.main() C:/Users/ycz/go/ccc.go:9 +0x49 exit status 2 è§£æï¼šé”™è¯¯recover ï¼Œä¸èƒ½åœ¨å¤šé‡defer åµŒå¥—é‡Œè°ƒç”¨recover ã€‚\nå¦å¤–éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œçˆ¶goroutine æ— æ³• recover ä½ å­goroutine çš„ panic ã€‚\nåŸå› æ˜¯ï¼Œgoroutine è¢«è®¾è®¡ä¸ºä¸€ä¸ªç‹¬ç«‹çš„ä»£ç æ‰§è¡Œå•å…ƒï¼Œæ‹¥æœ‰è‡ªå·±çš„æ‰§è¡Œæ ˆï¼Œä¸ä¸å…¶ä»–goroutine å…±äº«ä»»ä½•çš„æ•°æ®ã€‚\nä¹Ÿå°±æ˜¯è¯´ï¼Œæ— æ³•è®©goroutine æ‹¥æœ‰è¿”å›å€¼ï¼Œä¹Ÿæ— æ³•è®©goroutine æ‹¥æœ‰è‡ªèº«çš„ID ç¼–å·ã€‚\nå¦‚æœå¸Œæœ›æœ‰ä¸€ä¸ªå…¨å±€çš„panic æ•è·ä¸­å¿ƒï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡channel æ¥å®ç°ï¼Œå¦‚ä¸‹ç¤ºä¾‹ï¼š\nvar panicNotifyManage chan interface{} func StartGlobalPanicRecover() { panicNotifyManage = make(chan interface{}) go func() { select { case err := \u0026lt;-panicNotifyManage: fmt.Println(\u0026#34;panicNotifyManage---\u0026gt;\u0026#34;, err) } }() } func GoSafe(f func()) { go func() { defer func() { if err := recover(); err != nil { panicNotifyManage \u0026lt;- err } }() f() }() } func main() { StartGlobalPanicRecover() f1 := func() { panic(\u0026#34;f1 panic\u0026#34;) } GoSafe(f1) time.Sleep(time.Second) } è§£æï¼šGoSafe() æœ¬è´¨ä¸Šæ˜¯å¯¹go å…³é”®å­—è¿›è¡Œäº†ä¸€å±‚å°è£…ï¼Œç¡®ä¿åœ¨æ‰§è¡Œå¹¶å‘å•å…ƒå‰æ’å…¥ä¸€ä¸ªdefer ï¼Œä»è€Œä¿è¯èƒ½å¤Ÿrecover ä½panic ã€‚ä½†æ˜¯è¿™ä¸ªæ–¹æ¡ˆå¹¶ä¸å®Œç¾ï¼Œå¦‚æœå¼€å‘äººå‘˜ä¸ä½¿ç”¨GoSafe å‡½æ•°æ¥åˆ›å»ºgoroutine ï¼Œè€Œæ˜¯è‡ªå·±åˆ›å»ºï¼Œå¹¶ä¸”åœ¨ä»£ç ä¸­å‡ºç°äº†panic ï¼Œé‚£ä¹ˆä»ç„¶ä¼šé€ æˆç¨‹åºå´©æºƒã€‚\n","date":"2025-05-10T23:03:15+08:00","image":"https://hcraM41.github.io/p/defer/2_hu_6fea82e8afbdd5a7.png","permalink":"https://hcraM41.github.io/p/defer/","title":"defer"},{"content":"æºç å‰–æ é€šè¿‡æ—¥å¸¸éšæœºæ•°çš„ä»£ç ä½¿ç”¨ï¼Œçœ‹ä¸‹rankåŒ…å…·ä½“çš„åº•å±‚å®ç°ï¼š\nr := rand.New(rand.NewSource(time.Now().UnixNano())) // åˆå§‹åŒ–éšæœºå™¨ r.Intn(314)\t// ç”Ÿæˆ [0, 314) å†…çš„æ•´æ•° ä»r := rand.New(rand.NewSource(time.Now().UnixNano())) å¼€å§‹ã€‚\nåˆå§‹åŒ– Rand çš„æ—¶å€™ï¼Œé€šè¿‡rand.New(rand.NewSource(seed))åˆ›å»ºï¼Œæ‰€ä»¥çœ‹ä¸‹rand.New()çš„å®ç°ã€‚\n// New returns a new Rand that uses random values from src // to generate other random values. func New(src Source) *Rand { s64, _ := src.(Source64) return \u0026amp;Rand{src: src, s64: s64} } å¯ä»¥çœ‹åˆ° Rand ä½¿ç”¨çš„æ˜¯rand.NewSource()ä¼ å…¥çš„ Sourceï¼Œå› æ­¤æ¥ç€çœ‹ä¸‹rand.NewSource()çš„å®ç°ã€‚\n// NewSource returns a new pseudo-random Source seeded with the given value. // Unlike the default Source used by top-level functions, this source is not // safe for concurrent use by multiple goroutines. // The returned Source implements Source64. func NewSource(seed int64) Source { return newSource(seed) } func newSource(seed int64) *rngSource { var rng rngSource rng.Seed(seed) return \u0026amp;rng } çœ‹åˆ° Source çš„å®é™…ç±»å‹æ˜¯ rngSourceï¼Œå®ç°äº†æ¥å£ Sourceã€‚\ntype rngSource struct { tap int // index into vec feed int // index into vec vec [rngLen]int64 // current feedback register } çœ‹ä¸‹æ¥å£ Sourceçš„å®šä¹‰ã€‚\n// A Source represents a source of uniformly-distributed // pseudo-random int64 values in the range [0, 1\u0026lt;\u0026lt;63). // // A Source is not safe for concurrent use by multiple goroutines. type Source interface { Int63() int64 Seed(seed int64) } ä» newSource ä¸­ï¼Œå¯ä»¥çœ‹åˆ°è°ƒç”¨äº† rng.Seed(seed) ï¼Œå³ rngSource çš„ Seed ï¼Œè¿™ä¸ªå°±æ˜¯éšæœºå™¨åˆå§‹åŒ–çš„æ ¸å¿ƒå‡½æ•°ã€‚\nğŸ«µğŸ˜ const ( rngLen = 607 rngTap = 273 rngMax = 1 \u0026lt;\u0026lt; 63 rngMask = rngMax - 1 int32max = (1 \u0026lt;\u0026lt; 31) - 1 ) // Seed uses the provided seed value to initialize the generator to a deterministic state. func (rng *rngSource) Seed(seed int64) { rng.tap = 0 rng.feed = rngLen - rngTap seed = seed % int32max if seed \u0026lt; 0 { seed += int32max } if seed == 0 { seed = 89482311 } x := int32(seed) for i := -20; i \u0026lt; rngLen; i++ { x = seedrand(x) if i \u0026gt;= 0 { var u int64 u = int64(x) \u0026lt;\u0026lt; 40 x = seedrand(x) u ^= int64(x) \u0026lt;\u0026lt; 20 x = seedrand(x) u ^= int64(x) u ^= rngCooked[i] rng.vec[i] = u } } } // seed rng x[n+1] = 48271 * x[n] mod (2**31 - 1) func seedrand(x int32) int32 { const ( A = 48271 Q = 44488 R = 3399 ) hi := x / Q lo := x % Q x = A*lo - R*hi if x \u0026lt; 0 { x += int32max } return x } é€šè¿‡é€»è¾‘å¯ä»¥çœ‹å‡ºï¼Œè°ƒç”¨ rand.Seed æ¥è®¾ç½®ç§å­, å…¶å®å°±æ˜¯ç»™ rng.vec çš„ 607 ä¸ªæ§½è®¾ç½®å¯¹åº”çš„å€¼ã€‚é€šè¿‡ä¸Šé¢çš„æºç é‚£å¯ä»¥çœ‹å‡ºæ¥, rand.Seed ä¼šè°ƒç”¨ä¸€ä¸ª seedrand çš„å‡½æ•°, æ¥è®¡ç®—å¯¹åº”æ§½çš„å€¼ã€‚è¿™ä¸ªå‡½æ•°çš„è®¡ç®—ç»“æœå¹¶ä¸æ˜¯éšæœºçš„ï¼Œè€Œæ˜¯æ ¹æ® seed å®é™…ç®—å‡ºæ¥çš„ï¼Œå¦å¤–è¿™ä¸ªå‡½æ•°å¹¶ä¸æ˜¯éšä¾¿å†™çš„ï¼Œæ˜¯æœ‰ç›¸å…³çš„æ•°å­¦è¯æ˜çš„ã€‚ è¿™ä¹Ÿå¯¼è‡´äº†ç›¸åŒçš„ seedï¼Œæœ€ç»ˆè®¾ç½®åˆ° rng.vec é‡Œé¢çš„å€¼æ˜¯ç›¸åŒçš„ã€‚ æ€»ç»“ä¸‹ï¼Œéšæœºå™¨åˆå§‹åŒ–çš„é€»è¾‘å…¶å®å°±æ˜¯ä¸ºäº†è¿›è¡Œ rng.tapã€rng.feedã€ rng.vec çš„åˆå§‹åŒ–å·¥ä½œã€‚ å…¶ä¸­ï¼Œéœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼š ç›¸åŒçš„seedç§å­ æˆ–è€… seedç§å­å–æ¨¡int32æœ€å¤§å€¼åç›¸ç­‰ï¼› è¿™ä¸¤ç§æƒ…å†µéƒ½ä¼šå¯¼è‡´æœ€ç»ˆè®¾ç½®åˆ° rng.vec é‡Œé¢çš„å€¼æ˜¯ç›¸åŒçš„ã€‚\nä»¥ä¸Šå°±æ˜¯éšæœºå™¨åˆå§‹åŒ–ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹éšæœºæ•°æ˜¯å¦‚ä½•äº§ç”Ÿçš„ã€‚ ä»r.Intn(314) å¼€å§‹è§£æã€‚ ä»¥ rand.Intn() ä¸ºä¾‹ï¼Œçœ‹ä¸‹å…·ä½“çš„å®ç°ã€‚\n// Intn returns, as an int, a non-negative pseudo-random number in the half-open interval [0,n). // It panics if n \u0026lt;= 0. func (r *Rand) Intn(n int) int { if n \u0026lt;= 0 { panic(\u0026#34;invalid argument to Intn\u0026#34;) } if n \u0026lt;= 1\u0026lt;\u0026lt;31-1 { return int(r.Int31n(int32(n))) } return int(r.Int63n(int64(n))) } æŸ¥çœ‹æºç å¯äº†è§£åˆ°ï¼Œå°äºç­‰äº MaxInt32 çš„å€¼è°ƒç”¨çš„æ˜¯ r.Int31n ã€‚\n// Int31n returns, as an int32, a non-negative pseudo-random number in the half-open interval [0,n). // It panics if n \u0026lt;= 0. func (r *Rand) Int31n(n int32) int32 { if n \u0026lt;= 0 { panic(\u0026#34;invalid argument to Int31n\u0026#34;) } if n\u0026amp;(n-1) == 0 { // n is power of two, can mask return r.Int31() \u0026amp; (n - 1) } max := int32((1 \u0026lt;\u0026lt; 31) - 1 - (1\u0026lt;\u0026lt;31)%uint32(n)) v := r.Int31() for v \u0026gt; max { v = r.Int31() } return v % n } å¦‚æœä¼ å…¥çš„å€¼æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œåˆ™è°ƒç”¨çš„ r.Int31() \u0026amp; (n - 1) ï¼›\nå› ä¸ºä¼ å…¥çš„314ä¸æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œæ‰€ä»¥èµ°çš„æ˜¯ max := int32((1 \u0026lt;\u0026lt; 31) - 1 - (1\u0026lt;\u0026lt;31)%uint32(n)) ä¸‹é¢çš„é€»è¾‘ã€‚\né’ˆå¯¹ max è¿™ä¸ªé€»è¾‘ï¼Œéœ€è¦ç†è§£å®ƒçš„ç”¨é€”ï¼Œå®ƒå…¶å®æ˜¯å°† int32 0, (1 \u0026lt;\u0026lt; 31) - 1 èŒƒå›´å†…å°¾éƒ¨ï¼Œâ€œå–æ¨¡åâ€ï¼Œä¸èƒ½è¦†ç›– [0, n) çš„æ•°å€¼å»æ‰ï¼Œè¿™æ ·å°±ä¿è¯äº† [0, n) å†…å„ä¸ªæ•°å€¼å‡ºç°çš„æ¦‚ç‡æ˜¯ä¸€è‡´çš„ã€‚ä¸¾ä¾‹å¦‚ä¸‹ï¼š\nvar n int32 = 314 tail := (1 \u0026lt;\u0026lt; 31) % uint32(n) max := int32((1 \u0026lt;\u0026lt; 31) - 1 - (1\u0026lt;\u0026lt;31)%uint32(n)) fmt.Println(tail) // 282 fmt.Println(max) // 2147483365 fmt.Println(max % n) // 313 ç»§ç»­å¾€ä¸‹çœ‹é€»è¾‘ï¼Œæ— è®ºæ˜¯ä¸æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œæœ€ç»ˆéƒ½ä¼šè°ƒç”¨åˆ° r.Int31() ï¼Œæ‰€ä»¥éœ€è¦çœ‹ r.Int31() çš„å…·ä½“å®ç°ã€‚\n// Int31 returns a non-negative pseudo-random 31-bit integer as an int32. func (r *Rand) Int31() int32 { return int32(r.Int63() \u0026gt;\u0026gt; 32) } r.Int31() ä¸­è°ƒç”¨çš„æ˜¯ r.Int63() ï¼Œç„¶åå–ç»“æœçš„é«˜31ä½ä½œä¸º int32 éšæœºå€¼ï¼Œä¸‹é¢çœ‹ r.Int63() çš„å®ç°ã€‚\n// Int63 returns a non-negative pseudo-random 63-bit integer as an int64. func (r *Rand) Int63() int64 { return r.src.Int63() } å¯ä»¥çœ‹åˆ°ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯ r.src.Int63() ã€‚\nçœ‹ä¸‹Randçš„å®šä¹‰ï¼Œå› ä¸ºä¸Šé¢å·²ç»åˆ†æå‡ºäº†Randçš„srcçš„å…·ä½“å®ç°å°±æ˜¯ rngSourceã€‚\n// A Rand is a source of random numbers. type Rand struct { src Source s64 Source64 // non-nil if src is source64 // readVal contains remainder of 63-bit integer used for bytes // generation during most recent Read call. // It is saved so next Read call can start where the previous // one finished. readVal int64 // readPos indicates the number of low-order bytes of readVal // that are still valid. readPos int8 } å› æ­¤ï¼Œéšæœºæ•°çš„äº§ç”Ÿè°ƒç”¨çš„å°±æ˜¯ rngSource ç»“æ„ä½“çš„ Int63 å‡½æ•°ã€‚\n// Int63 returns a non-negative pseudo-random 63-bit integer as an int64. func (rng *rngSource) Int63() int64 { return int64(rng.Uint64() \u0026amp; rngMask) } å…¶ä¸­ rngMask è¡¨ç¤º Int64 çš„æœ€å¤§å€¼ï¼Œä½œç”¨æ˜¯ä½œä¸ºæ©ç ã€‚\nrngMax = 1 \u0026lt;\u0026lt; 63 rngMask = rngMax - 1 è€Œ rng.Uint64() ï¼Œåˆ™æ˜¯äº§ç”Ÿéšæœºæ•°çš„æ ¸å¿ƒå‡½æ•°ï¼›å®ƒçš„æ ¸å¿ƒé€»è¾‘å°±æ˜¯ä»æ•°ç»„ rngSource.vec ä¸­å–å‡ºéšæœºæ•°ã€‚\n// Uint64 returns a non-negative pseudo-random 64-bit integer as an uint64. func (rng *rngSource) Uint64() uint64 { rng.tap-- if rng.tap \u0026lt; 0 { rng.tap += rngLen } rng.feed-- if rng.feed \u0026lt; 0 { rng.feed += rngLen } x := rng.vec[rng.feed] + rng.vec[rng.tap] rng.vec[rng.feed] = x return uint64(x) } å®é™…ä¸Šï¼Œè°ƒç”¨ Intn(), Int31n(), Int63(), Int63n() ç­‰å…¶ä»–éšæœºå‡½æ•°ï¼Œæœ€ç»ˆè°ƒç”¨åˆ°éƒ½æ˜¯å‡½æ•° rngSource.Uint64() ã€‚å¯ä»¥çœ‹åˆ°æ¯æ¬¡è°ƒç”¨å°±æ˜¯åˆ©ç”¨ rng.feed, rng.tap ä» rng.vec ä¸­å–åˆ°ä¸¤ä¸ªå€¼ç›¸åŠ çš„ç»“æœè¿”å›ï¼ŒåŒæ—¶è¿™ä¸ªç»“æœåˆé‡æ–°æ”¾å…¥ rng.vecã€‚è¿™æ ·åšçš„ç›®çš„æ˜¯ï¼Œè®©éšæœºæ•°æ›´åŠ ä¸°å¯Œéšæœºï¼Œè€Œä¸æ˜¯ä»…å±€é™äº rng.vec æ•°ç»„ä¸­çš„å€¼ã€‚\næºç æ€»ç»“ é€šè¿‡ä»¥ä¸Šçš„æºç åˆ†æï¼Œå¯ä»¥æ€»ç»“å‡ºä»¥ä¸‹å‡ ç‚¹ï¼š\nrand.New åˆå§‹åŒ–å‡ºæ¥çš„ rand ä¸æ˜¯å¹¶å‘å®‰å…¨çš„ã€‚ å› ä¸ºæ¯æ¬¡åˆ©ç”¨ rng.feed, rng.tap ä» rng.vec ä¸­å–åˆ°éšæœºå€¼åä¼šå°†éšæœºå€¼é‡æ–°æ”¾å…¥ rng.vecï¼Œå½“å¤š goroutine åŒæ—¶è°ƒç”¨æ—¶å°±ä¼šæœ‰æ•°æ®ç«äº‰é—®é¢˜ã€‚å¦‚æœæƒ³å¹¶å‘å®‰å…¨ï¼Œå¯ä»¥ä½¿ç”¨å…¨å±€çš„éšæœºæ•°å‘ç”Ÿå™¨ rand.globalRandï¼Œå®ƒæ˜¯åŸºäºlockedSourceå®ç°çš„ï¼Œè¿›è¡Œäº†åŠ é”çš„é€»è¾‘ã€‚ ç›¸åŒseedç§å­ï¼Œæ¯æ¬¡è¿è¡Œçš„ç»“æœæ˜¯ä¸€æ ·çš„ã€‚ å› ä¸ºéšæœºæ•°æ˜¯ä» rng.vec æ•°ç»„ä¸­å–å‡ºæ¥çš„ï¼Œè¿™ä¸ªæ•°ç»„æ˜¯æ ¹æ®ç§å­ç”Ÿæˆçš„ï¼Œç›¸åŒçš„ç§å­ç”Ÿæˆçš„ rng.vec æ•°ç»„æ˜¯ç›¸åŒçš„ã€‚ ä¸åŒseedç§å­ï¼Œæ¯æ¬¡è¿è¡Œçš„ç»“æœå¯èƒ½ä¸€æ ·ã€‚ å› ä¸ºæ ¹æ®ç§å­ç”Ÿæˆ rng.vec æ•°ç»„æ—¶ä¼šæœ‰ä¸€ä¸ªå¯¹int32æœ€å¤§å€¼å–æ¨¡çš„æ“ä½œï¼Œæ¨¡åçš„ç»“æœå¯èƒ½ç›¸åŒï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªç§å­å¦‚æœç›¸å·®int32çš„æœ€å¤§å€¼ï¼Œå°±ä¼šå¯¼è‡´ rng.vec æ•°ç»„ç›¸åŒã€‚ r1 := rand.New(rand.NewSource(1111)) r2 := rand.New(rand.NewSource(1111 + math.MaxInt32)) fmt.Println(\u0026#34;ç¬¬ä¸€ä¸ªéšæœºå™¨ï¼š\u0026#34;, r1.Intn(10000)) // ç¬¬ä¸€ä¸ªéšæœºå™¨ï¼š 9241 fmt.Println(\u0026#34;ç¬¬ä¸€ä¸ªéšæœºå™¨ï¼š\u0026#34;, r1.Intn(10000)) // ç¬¬ä¸€ä¸ªéšæœºå™¨ï¼š 8842 fmt.Println(\u0026#34;ç¬¬ä¸€ä¸ªéšæœºå™¨ï¼š\u0026#34;, r1.Intn(10000)) // ç¬¬ä¸€ä¸ªéšæœºå™¨ï¼š 2221 fmt.Println(\u0026#34;ç¬¬äºŒä¸ªéšæœºå™¨ï¼š\u0026#34;, r2.Intn(10000)) // ç¬¬äºŒä¸ªéšæœºå™¨ï¼š 9241 fmt.Println(\u0026#34;ç¬¬äºŒä¸ªéšæœºå™¨ï¼š\u0026#34;, r2.Intn(10000)) // ç¬¬äºŒä¸ªéšæœºå™¨ï¼š 8842 fmt.Println(\u0026#34;ç¬¬äºŒä¸ªéšæœºå™¨ï¼š\u0026#34;, r2.Intn(10000)) // ç¬¬äºŒä¸ªéšæœºå™¨ï¼š 2221 ","date":"2025-05-10T22:26:34+08:00","image":"https://hcraM41.github.io/p/rand/2_hu_6fea82e8afbdd5a7.png","permalink":"https://hcraM41.github.io/p/rand/","title":"rand"}]